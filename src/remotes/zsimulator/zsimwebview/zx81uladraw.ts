/** Represents the ZX81 simulated screen.
 */
export class Zx81UlaDraw {
	// Screen height
	public static SCREEN_HEIGHT = 192;

	// Screen width
	public static SCREEN_WIDTH = 256;

	// The ZX81 ROM charset, 0x1E00-0x1FFF, TODO: get from ROM
	protected static romChars = new Uint8Array([
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xf0, 0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00,
		0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00,
		0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0,
		0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0,
		0x0f, 0x0f, 0x0f, 0x0f, 0xf0, 0xf0, 0xf0, 0xf0,
		0xff, 0xff, 0xff, 0xff, 0xf0, 0xf0, 0xf0, 0xf0,
		0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55,
		0x00, 0x00, 0x00, 0x00, 0xaa, 0x55, 0xaa, 0x55,
		0xaa, 0x55, 0xaa, 0x55, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x1c, 0x22, 0x78, 0x20, 0x20, 0x7e, 0x00,
		0x00, 0x08, 0x3e, 0x28, 0x3e, 0x0a, 0x3e, 0x08,
		0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00,
		0x00, 0x3c, 0x42, 0x04, 0x08, 0x00, 0x08, 0x00,
		0x00, 0x04, 0x08, 0x08, 0x08, 0x08, 0x04, 0x00,
		0x00, 0x20, 0x10, 0x10, 0x10, 0x10, 0x20, 0x00,
		0x00, 0x00, 0x10, 0x08, 0x04, 0x08, 0x10, 0x00,
		0x00, 0x00, 0x04, 0x08, 0x10, 0x08, 0x04, 0x00,
		0x00, 0x00, 0x00, 0x3e, 0x00, 0x3e, 0x00, 0x00,
		0x00, 0x00, 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x14, 0x08, 0x3e, 0x08, 0x14, 0x00,
		0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00,
		0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x10, 0x20,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x10,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00,
		0x00, 0x3c, 0x46, 0x4a, 0x52, 0x62, 0x3c, 0x00,
		0x00, 0x18, 0x28, 0x08, 0x08, 0x08, 0x3e, 0x00,
		0x00, 0x3c, 0x42, 0x02, 0x3c, 0x40, 0x7e, 0x00,
		0x00, 0x3c, 0x42, 0x0c, 0x02, 0x42, 0x3c, 0x00,
		0x00, 0x08, 0x18, 0x28, 0x48, 0x7e, 0x08, 0x00,
		0x00, 0x7e, 0x40, 0x7c, 0x02, 0x42, 0x3c, 0x00,
		0x00, 0x3c, 0x40, 0x7c, 0x42, 0x42, 0x3c, 0x00,
		0x00, 0x7e, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00,
		0x00, 0x3c, 0x42, 0x3c, 0x42, 0x42, 0x3c, 0x00,
		0x00, 0x3c, 0x42, 0x42, 0x3e, 0x02, 0x3c, 0x00,
		0x00, 0x3c, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00,
		0x00, 0x7c, 0x42, 0x7c, 0x42, 0x42, 0x7c, 0x00,
		0x00, 0x3c, 0x42, 0x40, 0x40, 0x42, 0x3c, 0x00,
		0x00, 0x78, 0x44, 0x42, 0x42, 0x44, 0x78, 0x00,
		0x00, 0x7e, 0x40, 0x7c, 0x40, 0x40, 0x7e, 0x00,
		0x00, 0x7e, 0x40, 0x7c, 0x40, 0x40, 0x40, 0x00,
		0x00, 0x3c, 0x42, 0x40, 0x4e, 0x42, 0x3c, 0x00,
		0x00, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x42, 0x00,
		0x00, 0x3e, 0x08, 0x08, 0x08, 0x08, 0x3e, 0x00,
		0x00, 0x02, 0x02, 0x02, 0x42, 0x42, 0x3c, 0x00,
		0x00, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00,
		0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7e, 0x00,
		0x00, 0x42, 0x66, 0x5a, 0x42, 0x42, 0x42, 0x00,
		0x00, 0x42, 0x62, 0x52, 0x4a, 0x46, 0x42, 0x00,
		0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00,
		0x00, 0x7c, 0x42, 0x42, 0x7c, 0x40, 0x40, 0x00,
		0x00, 0x3c, 0x42, 0x42, 0x52, 0x4a, 0x3c, 0x00,
		0x00, 0x7c, 0x42, 0x42, 0x7c, 0x44, 0x42, 0x00,
		0x00, 0x3c, 0x40, 0x3c, 0x02, 0x42, 0x3c, 0x00,
		0x00, 0xfe, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00,
		0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00,
		0x00, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00,
		0x00, 0x42, 0x42, 0x42, 0x42, 0x5a, 0x24, 0x00,
		0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00,
		0x00, 0x82, 0x44, 0x28, 0x10, 0x10, 0x10, 0x00,
		0x00, 0x7e, 0x04, 0x08, 0x10, 0x20, 0x7e, 0x00
	]);


	/** Draws a ZX Spectrum ULA screen into the given canvas.
	 * @param ctx The canvas 2d context to draw to.
	 * @param imgData A reusable array to create the pixel data in.
	 * @param dfile The DFILE data. If length is 0, FAST mode is active.
	 */
	public static drawUlaScreen(ctx: CanvasRenderingContext2D, imgData: ImageData, dfile: Uint8Array) {
		const pixels = imgData.data;
		let dfileIndex = dfile[0] === 0x76 ? 1 : 0;

		imgData.data.fill(0xFF);

		const width = Zx81UlaDraw.SCREEN_WIDTH / 8;
		const height = Zx81UlaDraw.SCREEN_HEIGHT / 8;
		let x = 0;
		let y = 0;

		while(y < height) {
			const char = dfile[dfileIndex++];
			if(x >= width || char === 0x76) {
				x = 0;
				++y;
				continue;
			};

			const inverted = (char & 0x80) !== 0;
			let charIndex = (char & 0x7f) * 8;
			let pixelIndex = (y * Zx81UlaDraw.SCREEN_WIDTH + x) * 8 * 4;

			// 8 lines par character
			for(let charY = 0; charY < 8; ++charY) {
				let byte = this.romChars[charIndex++];
				if (inverted) byte = byte ^ 0xFF;
				// 8 pixels par line
				for(let charX = 0; charX < 8; ++charX) {
					const bit = (byte & 0x80) === 0 ? 0xFF : 0x00;
					pixels[pixelIndex++] = bit;
					pixels[pixelIndex++] = bit;
					pixels[pixelIndex++] = bit;
					pixels[pixelIndex++] = 0xFF;
					byte = (byte & 0x7F) << 1;
				}
				// Next line
				pixelIndex += (Zx81UlaDraw.SCREEN_WIDTH - 8) * 4;
			}

			++x;
		}

		ctx.putImageData(imgData, 0, 0);
    }
}

